# 迷你推荐系统架构文档

## 版本信息

- 当前版本：v1.2.0
- 发布日期：2023-06-15

## 系统概述

本系统是一个迷你推荐系统，主要功能包括内容展示、用户交互、行为追踪和个性化推荐。系统采用前后端分离架构，前端使用React，后端使用FastAPI，数据库使用MySQL。

## 更新记录

### 2023-08-18 添加专业文本编辑器和SQL执行功能

- 添加了基于CodeMirror的专业文本编辑器，支持SQL语法高亮
- 实现了SQL执行器功能，支持直接在应用内编写和执行SQL
- 集成了Adminer数据库管理工具，支持在应用内直接访问PostgreSQL数据库
- 优化了ETL任务管理界面中的SQL编辑体验
- 添加了一键跳转到Adminer的功能，方便数据库操作

### 2023-08-17 添加ETL功能和数据分析系统

- 添加了ETL功能，支持MySQL到PostgreSQL、PostgreSQL到Redis、MySQL到Redis的数据同步
- 添加了ETL任务管理界面，支持任务创建、运行、取消和删除
- 添加了数据库连接管理功能，支持MySQL、PostgreSQL和Redis连接
- 集成了PostgreSQL数据仓库，用于数据分析和用户行为漏斗分析
- 添加了用户标签提取和推荐池生成功能
- 优化了Redis客户端中的ID处理方式，支持整数类型ID

### 2023-06-15 用户ID格式统一与按钮修复

- 将前端用户ID格式从带'u'前缀的字符串（如'u1001'）统一修改为数字格式（如'1001'），以匹配后端API的整数类型要求
- 修复了用户中心页面底部加载更多按钮不工作的问题
- 优化了用户中心页面的数据加载逻辑

## 系统架构

### 组件详细设计

#### 文本编辑器组件

- **组件名称**：`CodeEditor`
- **文件位置**：`/frontend/src/components/etl/CodeEditor.js`
- **依赖库**：`@uiw/react-codemirror`, `@codemirror/lang-sql`, `@codemirror/theme-one-dark`
- **功能**：提供专业的代码编辑体验，支持语法高亮、行号显示、代码折叠等功能
- **接口**：
  - `value`：编辑器内容
  - `onChange`：内容变化回调函数
  - `language`：代码语言（默认为SQL）
  - `theme`：编辑器主题（支持light和dark）
  - `height`：编辑器高度

#### SQL执行器组件

- **组件名称**：`SqlExecutor`
- **文件位置**：`/frontend/src/components/etl/SqlExecutor.js`
- **依赖组件**：`CodeEditor`
- **功能**：提供SQL编辑和执行功能，支持内嵌Adminer数据库管理工具
- **接口**：
  - `open`：控制对话框显示状态
  - `onClose`：关闭对话框回调函数
- **集成点**：
  - 在ETL管理页面中通过侧边栏按钮打开
  - 在任务编辑器中通过「在Adminer中打开」按钮跳转

### 前端架构

前端采用React框架，使用Redux进行状态管理，主要模块包括：

- **页面组件**：包括首页、详情页、用户中心、ETL管理等
- **状态管理**：使用Redux管理全局状态
- **API服务**：封装与后端的通信
- **埋点SDK**：用于用户行为追踪
- **编辑器组件**：基于CodeMirror的专业文本编辑器，支持语法高亮
- **SQL执行器**：支持在应用内编写和执行SQL，集成Adminer数据库管理工具

### 后端架构

后端采用FastAPI框架，主要模块包括：

- **API路由**：处理前端请求
- **数据模型**：定义数据库表结构
- **业务逻辑**：实现核心功能
- **推荐服务**：提供个性化推荐
- **ETL服务**：提供数据同步和转换功能

### 数据库架构

系统使用多种数据库：

#### MySQL（业务数据库）

- **users**：用户信息表
- **posts**：内容信息表
- **events**：用户行为表
- **features**：特征表
- **likes**：点赞表
- **favorites**：收藏表
- **etl_tasks**：ETL任务表
- **etl_task_history**：ETL任务历史表
- **etl_logs**：ETL日志表
- **database_connections**：数据库连接表

#### PostgreSQL（数据仓库）

- **raw模式**：原始数据表，从MySQL同步
- **dw模式**：数据仓库表，包含维度表和事实表
- **mart模式**：数据集市表，面向业务的分析表
- **stage模式**：中间处理数据表

#### Redis（缓存和推荐池）

- 用户浏览记录（消重）
- 用户推荐池
- 特征缓存

## 核心功能模块

### 用户模块

- 用户信息管理
- 用户偏好设置
- 用户标签提取
- 用户行为漏斗分析

### 内容模块

- 内容展示
- 内容标签提取
- 内容表现分析

### ETL模块

- 数据库连接管理
- ETL任务管理
- 数据同步（MySQL到PostgreSQL）
- 数据转换（PostgreSQL到Redis）
- 推荐池生成（MySQL到Redis）

### 数据分析模块

- 用户活跃度分析
- 内容表现分析
- 推荐效果分析
- 用户行为漏斗分析
- 内容详情
- 内容搜索

### 交互模块

- 浏览记录
- 点赞功能
- 收藏功能

### 推荐模块

- 基于用户的推荐
- 基于内容的推荐
- 热门推荐

### 数据分析模块

- 用户行为分析
- 内容热度分析

## 数据流

1. 用户在前端浏览内容
2. 前端记录用户行为并上报到后端
3. 后端存储用户行为数据
4. 推荐服务基于用户行为生成推荐结果
5. 前端展示推荐内容

## 技术栈

### 前端

- React
- Redux
- Ant Design
- Axios

### 后端

- Python
- FastAPI
- SQLAlchemy
- Pydantic

### 数据库

- MySQL

## 部署架构

系统采用Docker容器化部署，包括：

- 前端容器
- 后端容器
- 数据库容器

## 最近更新

### ID类型统一为整数类型

将系统中所有ID字段统一修改为整数类型，包括：

1. 数据库模型中的user_id、post_id、event_id、like_id、favorite_id等字段类型从字符串修改为BIGINT
2. API接口中的ID参数类型从str修改为int
3. Redis客户端中的ID处理方式进行了相应调整，确保正确处理整数类型ID
4. 数据模型schemas中的ID字段类型从str修改为int

这些修改统一了系统中ID的类型，提高了系统的一致性和性能。

### 点赞和收藏功能

新增了点赞和收藏功能，包括：

1. 后端新增likes和favorites表，用于存储用户的点赞和收藏记录
2. 后端实现点赞和收藏的API接口，包括创建、删除、查询等操作
3. 前端实现点赞和收藏的UI交互，包括按钮状态变化、计数更新等
4. 前端实现用户中心的点赞列表和收藏列表展示

这些功能增强了用户与内容的互动体验，同时为推荐系统提供了更多的用户偏好信号。